<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bookstore - ISET Tozeur</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <header class="hero">
    <h1>Bookstore — ISET Tozeur</h1>
    <p>Parcourez les livres et passez commande.</p>
  </header>

  <main class="container">
    <section id="books-section">
      <h2>Livres disponibles</h2>
      <div id="books-list">Chargement…</div>
    </section>

    <section id="order-section">
      <h2>Passer une commande</h2>
      <form id="order-form">
        <label>Votre nom <input type="text" id="customer_name" required /></label>
        <label>Votre email <input type="email" id="customer_email" required /></label>
        <label>Book ID <input type="number" id="book_id" required /></label>
        <label>Quantité <input type="number" id="quantity" value="1" min="1" required /></label>
        <button type="submit">Commander</button>
      </form>
      <div id="order-result"></div>
    </section>
  </main>

  <footer class="footer">
    <small>ISET Tozeur — TP Microservices</small>
  </footer>

<script>
const GATEWAY = "/api"; // nginx forwarder
async function loadBooks(){
  const el = document.getElementById("books-list");
  try{
    const res = await fetch(GATEWAY+"/books");
    const books = await res.json();
    if(!Array.isArray(books)) { el.innerText = JSON.stringify(books); return; }
    el.innerHTML = books.map(b => 
      `<div class="book">
         <strong>${b.id}. ${b.title}</strong><br/>
         Auteur: ${b.author} — Prix: ${b.price} — Stock: ${b.stock}
       </div>`).join("");
  }catch(e){
    el.innerText = "Erreur de chargement des livres.";
  }
}

document.getElementById("order-form").addEventListener("submit", async (ev)=>{
  ev.preventDefault();
  const data = {
    customer_name: document.getElementById("customer_name").value,
    customer_email: document.getElementById("customer_email").value,
    book_id: Number(document.getElementById("book_id").value),
    quantity: Number(document.getElementById("quantity").value)
  };
  const resultDiv = document.getElementById("order-result");
  resultDiv.innerText = "Envoi...";
  try{
    const res = await fetch(GATEWAY+"/orders", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(data)
    });
    const json = await res.json();
    resultDiv.innerText = JSON.stringify(json);
    await loadBooks(); // rafraichir le stock
  }catch(e){
    resultDiv.innerText = "Erreur lors de la commande.";
  }
});

loadBooks();
</script>
</body>
</html>
